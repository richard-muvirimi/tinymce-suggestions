<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<script src="tinymce/tinymce.min.js"></script>		
		
		<script>
			let suggestionNode;
			let waiting = false;
			let waitingText;
			const debounceTime = 250; //ms
			const suggestionTextColor = "#dee7f1";
			const suggestionNodeId = "suggestionid"
			const minLengthSearch = 3;
			const excludedKeys = [
				'Space',
				'Enter',
				'NumpadEnter',
				'Delete',
				'Escape',
				
			];

			const neutralKeys = [
									'ShiftLeft',
									'ShiftRight',
									'AltRight',
									'AltLeft',
									'ControlLeft',
									'ControlRight'
								]

			let wilayasList = [
				'Adrar',
				'Alger',
				'Tizi-Ouzou',
				'Oran',
				'Ouargla',
				'Annaba'
			]

			function findWord( txt ) {
				return wilayasList.find(elm => elm.toLocaleLowerCase().startsWith(txt.toLocaleLowerCase()));
			}

			function debounce(cb, delay = debounceTime) {
				let timeout

				return (...args) => {
					clearTimeout(timeout)
					timeout = setTimeout(() => {
					cb(...args)
					}, delay)
				}
			}

			function cancelEvent(e){
				e.stopPropagation();
				e.preventDefault();
			}

			function removeSuggestionNode(){
				suggestionNode && suggestionNode.remove();
				suggestionNode = undefined;
			}			

			/*function getCursorWord(ed){
				removeSuggestionNode()
				var rng = ed.selection.getRng(1);
				//var rng2 = rng.cloneRange();

				var dataBefore = rng.startContainer.data;
				//console.log(rng2);
				
				let bookmark = ed.selection.getBookmark();
				console.log(bookmark)

				suggestionNode = ed.getDoc().createElement("span");
				suggestionNode.style.color = '#dee7f1';
				suggestionNode.innerHTML = 'Salut';
				nesuggestionNodewNode.id = "suggestionid";
				let offset =  ed.selection.getSel().focusOffset; console.log(offset)
				rng.insertNode(suggestionNode);

				var rngX = ed.selection.getRng(1);
				var dataAfter = rngX.startContainer.data;

				console.log({dataBefore, dataAfter});

				let nodeSuggestion = ed.dom.select("#suggestionid"); console.log(nodeSuggestion);
				console.log(nodeSuggestion[0].lastChild);
				ed.selection.setCursorLocation(nodeSuggestion[0].firstChild, 0);
				ed.selection.collapse(0);
				waiting = true;

				//ed.execCommand('mceInsertContent', false, '<span style="color:#dee7f1">Salut</span>')
				//ed.selection.moveToBookmark(bookmark);
			}*/

			function getTheWordToCheck(theText, theSub){
				let re = new RegExp(`${theSub}$`, "gi")
				let minus = theText.replace(re, "");

				//console.log({minus});
				return minus.split(' ').pop();			
			}

			function keyCheck( keyCode ){
				return excludedKeys.indexOf(keyCode) == -1
			}

			function getCompletion(typed, word) {
				let re = new RegExp(`^${typed}`, "gi")
				
				return word.replace(re, "");
			}

			function insertCompletionNode(ed, txt){
				removeSuggestionNode();

				let rng = ed.selection.getRng(1);
				
				suggestionNode = ed.getDoc().createElement("span");
				suggestionNode.style.color = suggestionTextColor;
				suggestionNode.innerHTML = txt;
				suggestionNode.id = suggestionNodeId;
				let offset =  ed.selection.getSel().focusOffset;
				rng.insertNode(suggestionNode);

				let nodeSuggestion = ed.dom.select(`#${suggestionNodeId}`);

				if(nodeSuggestion[0].lastChild != null){
					ed.selection.setCursorLocation(nodeSuggestion[0].firstChild, 0);					
				}

				ed.selection.collapse(0);

				waiting = true;
				waitingText = txt;
			}

			function resetSuggestion() {
				waiting = false;
				waitingText = undefined;
			}

			function completeWord(ed) {
				removeSuggestionNode();
				ed.execCommand('mceInsertContent', false, waitingText);
				ed.selection.collapse(1);
				
				resetSuggestion();
			}

			function changeSuggestionDom(ed, key){
				if(waitingText && waitingText.toLocaleLowerCase().startsWith(key.toLocaleLowerCase())){
					waitingText = waitingText.substring(1);
					removeSuggestionNode()
					insertCompletionNode(ed, waitingText)
				}else{
					removeSuggestionNode()
					resetSuggestion();
				}
			}

			function startProcess(ed){
				let offset =  ed.selection.getSel().focusOffset;
				let rng = ed.selection.getRng(1);
				let theText = rng.startContainer.data;

				if(theText){
					let theSub = theText.substring(offset);

					if(theSub.length == 0 || theSub.match(/^\s/g)){
						const wordToCheck = getTheWordToCheck(theText, theSub);
						if(wordToCheck.length >= minLengthSearch){
							let wordFound = findWord(wordToCheck)
							if(wordFound != undefined){
								let substr = getCompletion(wordToCheck, wordFound)
								insertCompletionNode(ed, substr);
							}							
						}
					}else{
						//console.log(theSub.charAt(0));
					}
				}else{
					//TODO
				}				
			}

			tinymce.init({
				selector: '#mytextarea',
				spellchecker_active: false,
				setup: (editor) => { 
					let process = debounce(function(event, editor) {
							if(keyCheck(event.code)){
								startProcess(editor)
							}else{
								//removeSuggestionNode();
								//resetSuggestion();
							}

							var name = event.key;
							var char = event.code;
							//console.log(`Key pressed ${name} \r\n Key code value: ${char}`)
						});
					editor.on('keyup', (event) => {
						if(!waiting){
							process(event, editor)
						}else{
							/*if(keyCheck(event.code)){
								//console.log('TODO', event.key);
								
							}else{
								removeSuggestionNode();
								resetSuggestion();
							}*/							
						}						
					});

					editor.on('keydown', (event) => { //console.log(event.code);
						if(event.code == 'Tab' && waiting){
							cancelEvent(event)
							completeWord(editor)
						}else{
							if(!keyCheck(event.code)){
								removeSuggestionNode();
								resetSuggestion();
							}else if(waiting && neutralKeys.indexOf(event.code) == -1){
								changeSuggestionDom(editor, event.key)
							}
						}
					});

					editor.on('blur', (e) => {
						removeSuggestionNode();
						resetSuggestion();
					})	
					
					editor.on('click', (e) => {
						removeSuggestionNode();
						resetSuggestion();
					})
				}
			});
		</script>
	</head>
	
	<body>
		<h1>TinyMCE Quick Start Guide</h1>
		<textarea id="mytextarea">
			<p>Use one of this words from the list to see autocomplete. Use Tab for autocompletion</p>
			<p>[
				Adrar,
				Alger,
				Tizi-Ouzou,
				Oran,
				Ouargla,
				Annaba
			]</p>
		</textarea>
	</body>
</html>